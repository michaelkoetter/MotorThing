<velocity class="app-page">
    <header class="header-bar">
        <a data-navigation="$previous-page" class="btn pull-left icon icon-arrow-back"></a>
        <div class="center">
            <h1 class="title">Velocity Mode</h1>
        </div>
    </header>

    <div class="content">
      <ul class="list">
        <li class="divider">
          <button class="btn btn-flat pull-left icon icon-chevron-left" disabled={ motor <= 0 }
            data-navigation="velocity/{ address }/{ motor - 1 }"></button>
          Axis { motor }
          <button class="btn btn-flat pull-right icon icon-chevron-right"
            data-navigation="velocity/{ address }/{ motor + 1 }"></button>
        </li>
      </ul>
        <div class="padded-full">

          <div class="input-wrapper">
              <input class="with-label" type="number" name="speed" id="speed"
                oninput="{ input }" value="{ model.speed }">
              <label class="floating-label" for="speed">Speed</label>
          </div>

            <ul class="list">
                <li class="padded-for-list">
                    <label class="radio">
                        <input type="radio" name="direction" value="left"
                          onchange="{ this.input }" checked="{ model.direction == 'left' }">
                        Rotate Left
                        <span></span>
                    </label>
                </li>
                <li class="padded-for-list">
                    <label class="radio">
                        <input type="radio" name="direction" value="right"
                          onchange="{ input }" checked="{ model.direction == 'right' }">
                        Rotate Right
                        <span></span>
                    </label>
                </li>
            </ul>
            <button class="btn fit-parent primary padded-top" onclick="{ start }">Start</button>
            <button class="btn fit-parent negative padded-top" onclick="{ stop }">Stop</button>
            <button class="btn fit-parent padded-top" onclick="{ setHome }">Set Home</button>
            <button class="btn fit-parent padded-top" onclick="{ getPosition }">Get Position</button>
        </div>

    </div>

    <script>
        import { rotate, stop, setHome, getPosition } from '../js/tmclAPI'
        import { setEndPosition } from '../js/actions/timelapse.js'

        this.model = {
          speed: 100,
          direction: 'left'
        }

        this.input = (e) => {
          this.model[e.target.name] = e.target.value;
        }

        this.start = () => {
          rotate(this.address, this.motor, this.model.direction, parseInt(this.model.speed))
        }

        this.setHome = () => {
          setHome(this.address, this.motor)
        }

        this.getPosition = () => {
          getPosition(this.address, this.motor)
        }

        this.stop = () => {
          stop(this.address, this.motor)
        }

        const AP_ACTUAL_POSITION = 1

        // this.store.on('change', () => {
        //     let state = this.state()
        //     if (state.tmcl.axisParameters[AP_ACTUAL_POSITION]) {
        //       // quick hack: whenever there is a position (from GET_ACTUAL_POSITION)
        //       // we assume it's the end position
        //       let actualPosition = state.tmcl.axisParameters[AP_ACTUAL_POSITION]
        //       if (actualPosition != state.timelapse.endPosition) {
        //         console.debug('Timlapse: new end position ', actualPosition)
        //         this.store.dispatch(setEndPosition(actualPosition))
        //       }
        //     }
        // })

        this.on('hashchanged', (address, motor = 0) => {
          this.address = parseInt(address)
          this.motor = parseInt(motor)
          this.update()
        })
    </script>
</velocity>
